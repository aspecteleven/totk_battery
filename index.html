<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lantern Control</title>
    <style>
        :root { --accent: #ffb700; --bg: #1a1a1a; --panel: #2d2d2d; --text: #eee; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        
        h1 { font-weight: 300; letter-spacing: 4px; color: var(--accent); margin-bottom: 30px; }

        .container { background: var(--panel); padding: 30px; border-radius: 20px; width: 320px; box-shadow: 0 15px 50px rgba(0,0,0,0.5); }
        
        /* Buttons */
        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-main { background: var(--accent); color: #000; }
        .btn-main:hover { background: #ffcc40; }
        .btn-sec { background: #444; color: #aaa; }
        .btn-sec:hover { background: #555; color: #fff; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Controls */
        .control-group { margin-bottom: 25px; }
        label { display: flex; justify-content: space-between; font-size: 13px; color: #aaa; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        
        /* Inputs */
        input[type="color"] { width: 100%; height: 50px; border: none; border-radius: 8px; cursor: pointer; background: none; }
        input[type="range"] { width: 100%; cursor: pointer; accent-color: var(--accent); }
        
        /* Mode Switcher */
        .mode-switch { display: flex; background: #222; border-radius: 10px; padding: 5px; margin-bottom: 20px; }
        .mode-opt { flex: 1; text-align: center; padding: 10px; cursor: pointer; border-radius: 8px; font-size: 14px; color: #777; transition: 0.3s; }
        .mode-opt.active { background: #444; color: var(--accent); font-weight: bold; }

        .hidden { display: none; }
        .status { text-align: center; font-size: 12px; color: #555; margin-top: 10px; }
    </style>
</head>
<body>

    <h1>LANTERN</h1>

    <div class="container">
        <!-- Connect / Disconnect -->
        <div class="btn-group">
            <button id="connectBtn" class="btn-main">üîå CONNECT</button>
            <button id="disconnectBtn" class="btn-sec" disabled>‚ùå</button>
        </div>

        <!-- Mode Selection -->
        <div class="mode-switch">
            <div class="mode-opt active" id="modeSolid" onclick="setMode('solid')">SOLID</div>
            <div class="mode-opt" id="modeFade" onclick="setMode('fade')">FADE</div>
        </div>

        <!-- Common Controls -->
        <div class="control-group">
            <label>Color</label>
            <input type="color" id="colorPicker" value="#ffe600" disabled>
        </div>

        <div class="control-group">
            <label>Master Brightness</label>
            <input type="range" id="brightSlider" min="0" max="1" step="0.05" value="0.8" disabled>
        </div>

        <!-- Fade Specific Controls -->
        <div id="fadeControls" class="hidden">
            <div class="control-group">
                <label>Fade Speed</label>
                <input type="range" id="speedSlider" min="0.1" max="3.0" step="0.1" value="0.5" disabled>
            </div>
            <div class="control-group">
                <label>Variety / Randomness</label>
                <input type="range" id="varSlider" min="0" max="1.0" step="0.1" value="0.0" disabled>
            </div>
        </div>

        <button id="defaultBtn" class="btn-sec" style="width:100%" disabled>RESET TO DEFAULTS</button>

        <div class="status" id="statusText">Ready to connect</div>
    </div>

    <script>
        let port, writer;
        let currentMode = "solid";
        
        const ui = {
            connect: document.getElementById('connectBtn'),
            disconnect: document.getElementById('disconnectBtn'),
            default: document.getElementById('defaultBtn'),
            solid: document.getElementById('modeSolid'),
            fade: document.getElementById('modeFade'),
            fadePanel: document.getElementById('fadeControls'),
            color: document.getElementById('colorPicker'),
            bright: document.getElementById('brightSlider'),
            speed: document.getElementById('speedSlider'),
            vary: document.getElementById('varSlider'),
            status: document.getElementById('statusText')
        };

        // --- USB CONNECTION ---
        ui.connect.addEventListener('click', async () => {
            if (!navigator.serial) return alert("Use Chrome/Edge.");
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                const textEncoder = new TextEncoderStream();
                textEncoder.readable.pipeTo(port.writable);
                writer = textEncoder.writable.getWriter();
                enableControls(true);
            } catch (e) { console.log(e); ui.status.innerText = "Connection Failed"; }
        });

        ui.disconnect.addEventListener('click', async () => {
            if (writer) {
                await writer.close();
                await port.close();
                writer = null; port = null;
                enableControls(false);
            }
        });

        function enableControls(enabled) {
            ui.connect.disabled = enabled;
            ui.disconnect.disabled = !enabled;
            ui.default.disabled = !enabled;
            ui.color.disabled = !enabled;
            ui.bright.disabled = !enabled;
            ui.speed.disabled = !enabled;
            ui.vary.disabled = !enabled;
            ui.status.innerText = enabled ? "Connected" : "Disconnected";
            if(enabled) {
                ui.connect.innerText = "CONNECTED";
                ui.connect.style.background = "#4CAF50";
            } else {
                ui.connect.innerText = "üîå CONNECT";
                ui.connect.style.background = "";
            }
        }

        // --- MODE SWITCHING ---
        window.setMode = (mode) => {
            currentMode = mode;
            if (mode === 'solid') {
                ui.solid.classList.add('active');
                ui.fade.classList.remove('active');
                ui.fadePanel.classList.add('hidden');
            } else {
                ui.solid.classList.remove('active');
                ui.fade.classList.add('active');
                ui.fadePanel.classList.remove('hidden');
            }
            sendData(true); // Save immediately on mode switch
        };

        // --- DATA SENDING ---
        function hexToRgb(hex) {
            const res = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return res ? [parseInt(res[1], 16), parseInt(res[2], 16), parseInt(res[3], 16)] : [0,0,0];
        }

        async function sendData(save = false) {
            if (!writer) return;

            const payload = {
                mode: currentMode,
                color: hexToRgb(ui.color.value),
                brightness: parseFloat(ui.bright.value),
                fade_speed: parseFloat(ui.speed.value),
                fade_var: parseFloat(ui.vary.value),
                save: save // Tell Pico to write to memory
            };

            try {
                await writer.write(JSON.stringify(payload));
            } catch (e) { ui.status.innerText = "Error sending data"; }
        }

        // --- DEFAULTS ---
        ui.default.addEventListener('click', () => {
            ui.color.value = "#ffe600";
            ui.bright.value = 0.8;
            ui.speed.value = 0.5;
            ui.vary.value = 0.0;
            setMode('solid'); // Will trigger sendData(true)
        });

        // --- EVENTS ---
        // 'input' fires while dragging (fast, no save)
        ui.color.addEventListener('input', () => sendData(false));
        ui.bright.addEventListener('input', () => sendData(false));
        ui.speed.addEventListener('input', () => sendData(false));
        ui.vary.addEventListener('input', () => sendData(false));

        // 'change' fires when mouse released (save settings)
        ui.color.addEventListener('change', () => sendData(true));
        ui.bright.addEventListener('change', () => sendData(true));
        ui.speed.addEventListener('change', () => sendData(true));
        ui.vary.addEventListener('change', () => sendData(true));

    </script>
</body>
</html>