<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zonai Lantern</title>
    <style>
        /* --- VARIABLES --- */
        :root { 
            --accent: #5bc0cf; --accent-light: #b3f4ff; --accent-dim: #997a23;  
            --panel-bg: rgba(16, 34, 46, 0.95); --text: #a8d8e6; 
            --glow-rgb: 0, 0, 0; --glow-opacity: 0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #10222e; box-shadow: inset 0 0 20vh #091320;
            color: var(--text); height: 100vh; width: 100vw; overflow: hidden; user-select: none;
        }

        /* --- LAYERS --- */
        .container, .battery_container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .battery_display { position: relative; width: 474px; height: 779px; }
        /* Layers */
        .layer { position: absolute; width: 100%; height: 100%; top: 0; left: 0; background-size: cover; background-repeat: no-repeat; }
        
        /* Battery specific */
        .battery_body { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 21; background-size: contain; }
        .battery_glass { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 22; background-size: contain; }
        
        /* Glow Logic */
        .battery_glass_glow {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 23;
            background: radial-gradient(circle, rgba(var(--glow-rgb), var(--glow-opacity)) 0%, rgba(var(--glow-rgb), var(--glow-opacity)) 100%);
            mix-blend-mode: overlay; 
            /* Mask applied via JS for WiFi compatibility */
        }
        .battery_glass_glow_overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 24; opacity: .5; mix-blend-mode: multiply;
            /* Mask applied via JS */
        }

        /* --- DASHBOARD --- */
        .control-panel {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 900px; max-width: 95vw; height: 140px;
            background: var(--panel-bg); border: 2px solid var(--accent-dim); border-radius: 16px;
            padding: 15px 25px; z-index: 100; backdrop-filter: blur(8px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            display: flex; align-items: center; justify-content: space-between; gap: 20px;
        }
        h1 { position: absolute; top: -30px; left: 20px; font-weight: 300; letter-spacing: 4px; color: var(--accent); font-size: 14px; text-shadow: 0 0 5px black; }

        .sec-system { width: 140px; display: flex; flex-direction: column; justify-content: center; gap: 5px; }
        
        /* Buttons */
        button { border: 1px solid var(--accent); border-radius: 6px; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 11px; padding: 8px; background: rgba(0,0,0,0.3); color: var(--text); transition: 0.2s; }
        button:hover { background: var(--accent); color: #000; }
        button:disabled { opacity: 0.3; cursor: not-allowed; border-color: #555; }
        
        .btn-connect { border-color: #4CAF50; color: #4CAF50; }
        .btn-connect:hover { background: #4CAF50; }
        .btn-disconnect { border-color: #ff6b6b; color: #ff6b6b; }
        .btn-disconnect:hover { background: #ff6b6b; }

        select { width: 100%; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid #444; color: #aaa; border-radius: 4px; font-size: 11px; cursor: pointer; }
        select option { background: #10222e; color: var(--accent); }

        .sec-controls { flex: 1; display: flex; align-items: center; justify-content: space-around; gap: 20px; }
        .control-group { display: flex; flex-direction: column; min-width: 90px; }
        label { font-size: 10px; color: #888; text-transform: uppercase; margin-bottom: 5px; display: flex; justify-content: space-between; }
        input[type="color"] { width: 70px; height: 35px; border: 1px solid var(--accent-dim); background: none; cursor: pointer; border-radius: 4px; }
        input[type="checkbox"] { width: 14px; height: 14px; accent-color: var(--accent); cursor: pointer; }

        /* Sliders */
        .custom-slider-container { position: relative; height: 20px; width: 100%; margin-top: 5px; cursor: pointer; }
        .custom-slider-track { position: absolute; top: 8px; left: 0; right: 0; height: 4px; background: #333; border-radius: 2px; }
        .custom-slider-highlight { position: absolute; top: 8px; height: 4px; background: var(--accent); z-index: 1; }
        .thumb { position: absolute; top: 0px; width: 20px; height: 20px; background: #10222e; border: 2px solid var(--accent); border-radius: 50%; z-index: 3; }
        .custom-slider-container.disabled { opacity: 0.5; pointer-events: none; }

        /* WIFI MODAL */
        #wifiModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background: var(--panel-bg); border: 2px solid var(--accent); padding: 30px; border-radius: 10px;
            display: flex; flex-direction: column; gap: 15px; width: 300px;
        }
        .modal-content input { padding: 10px; background: rgba(0,0,0,0.5); border: 1px solid #555; color: white; border-radius: 4px; }
        
        .hidden { display: none !important; }
        
        /* Intro/Reset Styles Omitted for brevity, assuming standard Intro setup */
        #introScreen { position: absolute; width: 100%; height: 100%; background: #10222e; z-index: 500; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .intro-symbol { width: 400px; height: 400px; background-size: contain; background-repeat: no-repeat; margin-bottom: 20px; filter: drop-shadow(0 0 20px var(--accent)); }
        #resetUserBtn { position: fixed; bottom: 20px; left: 20px; width: 30px; height: 30px; background: #800; color: #fff; z-index: 999; display: flex; justify-content: center; align-items: center; cursor: pointer; border-radius: 4px; }
        #offlineBtn { position: fixed; bottom: 20px; left: 20px; width: 30px; height: 30px; border: 2px solid var(--accent-dim); background: rgba(153, 122, 35, 0.2); cursor: pointer; z-index: 1000; display: none; }
        #offlineBtn.active { background: var(--accent); }
    </style>
</head>
<body>

    <!-- ASSETS (Backgrounds assigned via JS for Hybrid Mode) -->
    <div class="container">
        <div class="layer" id="bg1"></div><div class="layer" id="bg2"></div>
        <div class="layer" id="bg3"></div><div class="layer" id="bg4"></div>
        <div class="layer" id="el1"></div><div class="layer" id="el2"></div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp">
        <div class="battery_container">
            <div class="battery_display">
                <div class="battery_body" id="batBody"></div>
                <div class="battery_glass" id="batGlass"></div>
                <div class="battery_glass_glow" id="glowLayer"></div>
                <div class="battery_glass_glow_overlay" id="glowOverlay"></div>
            </div>
        </div>

        <div class="control-panel">
            <h1>ZONAI LANTERN</h1>
            <div class="sec-system">
                <button id="connToggle" class="btn-connect">Connect (USB)</button>
                <button id="wifiSetupBtn" style="display:none;">Setup WiFi</button>
                <select id="modeSelect" disabled>
                    <option value="solid">Solid Color</option>
                    <option value="fade">Breathing Fade</option>
                    <option value="snake">Snake</option>
                </select>
            </div>
            <div class="sec-controls" id="controlsArea"></div>
            <div class="sec-actions">
                <button id="defaultBtn" disabled>Defaults</button>
                <div class="status" id="statusText">Ready</div>
            </div>
        </div>
    </div>

    <!-- WIFI MODAL -->
    <div id="wifiModal">
        <div class="modal-content">
            <h3 style="color:var(--accent); text-align:center;">CONFIGURE WIFI</h3>
            <input type="text" id="wifiSSID" placeholder="Network Name (SSID)">
            <input type="password" id="wifiPass" placeholder="Password">
            <button onclick="saveWiFi()">SAVE TO LANTERN</button>
            <button onclick="document.getElementById('wifiModal').style.display='none'" style="border-color:#555;">CANCEL</button>
        </div>
    </div>

    <!-- INTRO & RESET (Simplified for Hybrid) -->
    <div id="introScreen">
        <div class="intro-symbol" id="introSym"></div>
        <div style="text-align:center; height:100px;">
            <div id="introText" style="color:#fff; font-size:20px; margin-bottom:10px;"></div>
            <input type="text" id="nameInput" placeholder="ENTER NAME" style="padding:10px; text-align:center; text-transform:uppercase;">
        </div>
        <button id="continueBtn" style="margin-top:20px; opacity:0; transition:1s;">CONTINUE</button>
    </div>
    <div id="resetUserBtn">X</div>
    <div id="offlineBtn"></div>

    <script>
        // --- 1. HYBRID CONFIGURATION ---
        // REPLACE THIS URL WITH YOUR GITHUB PAGES URL (Must end with /)
        const REPO_URL = "https://aspecteleven.github.io/totk_battery/"; 
        
        // Detect Mode
        const isWiFiMode = (location.hostname.indexOf('zonai') > -1 || location.hostname.indexOf('192.168') > -1);
        const ASSET_BASE = isWiFiMode ? REPO_URL : ""; // Pico uses remote assets, GitHub uses local

        // Apply Assets
        function setBg(id, file) { document.getElementById(id).style.backgroundImage = `url('${ASSET_BASE}images/${file}')`; }
        setBg('bg1', 'stone_overlay_left.webp'); setBg('bg2', 'stone_overlay_right.webp');
        setBg('bg3', 'stone_left.webp'); setBg('bg4', 'stone_right.webp');
        setBg('el1', 'elements_top.png'); setBg('el2', 'elements_bottom.png');
        setBg('batBody', 'battery_body_dark.png'); setBg('batGlass', 'battery_glass.png');
        setBg('introSym', 'symbol.png');
        setBg('glowOverlay', 'battery_glass.png');
        
        // Apply Masks via CSS Mask (Needs URL)
        const glowUrl = `url('${ASSET_BASE}images/battery_glass_mask_glow.png')`;
        document.getElementById('glowLayer').style.maskImage = glowUrl;
        document.getElementById('glowLayer').style.webkitMaskImage = glowUrl;
        
        // Complex mask for overlay shadow
        const cssStyle = document.createElement('style');
        cssStyle.innerHTML = `
            .battery_glass_glow_overlay:before {
                content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                background: ${glowUrl} no-repeat;
                filter: drop-shadow(0 0 10px rgba(var(--glow-rgb), var(--glow-opacity))) 
                        drop-shadow(0 0 150px rgba(var(--glow-rgb), var(--glow-opacity))) 
                        drop-shadow(0 0 50px rgba(255, 255, 255, var(--glow-opacity)));
                transition: filter 0.1s;
            }
        `;
        document.head.appendChild(cssStyle);

        // --- 2. STATE & USB ---
        let port, writer, reader, keepReading = false, isConnected = false, isOffline = false;
        let serialBuffer = "";

        let appState = {
            mode: "solid", solid_color: [255, 230, 0], solid_bright: 0.8,
            fade_color: [255, 200, 0], fade_color_2: [255, 220, 0], fade_use_2: true, fade_min: 0.1, fade_max: 0.9, fade_speed: 0.9,
            snake_color_mode: "rainbow", snake_color_1: [255, 0, 0], snake_color_2: [0, 0, 255], snake_cw: true, snake_speed: 1.0
        };

        // --- 3. INIT LOGIC ---
        window.addEventListener('load', () => {
            if (isWiFiMode) {
                // WiFi Mode: Skip Intro, Hide USB buttons
                document.getElementById('introScreen').style.display = 'none';
                document.getElementById('resetUserBtn').style.display = 'none';
                document.getElementById('connToggle').style.display = 'none';
                document.getElementById('statusText').innerText = "WiFi Mode";
                
                isConnected = true;
                enableControls('wifi');
                
                // Poll for state
                setInterval(fetchWiFiState, 2000);
                fetchWiFiState();
            } else {
                // USB Mode: Run Intro
                runIntro();
            }
        });

        // --- 4. DATA HANDLING ---
        async function sendData(save) {
            appState.save = save;
            if (isWiFiMode) {
                // HTTP POST
                try {
                    await fetch('/api/state', { method: 'POST', body: JSON.stringify(appState) });
                } catch(e) {}
            } else if (isConnected && writer) {
                // USB SERIAL
                try { await writer.write(JSON.stringify(appState) + "\n"); } catch(e){}
            }
        }

        async function fetchWiFiState() {
            try {
                const res = await fetch('/api/state');
                const data = await res.json();
                Object.assign(appState, data);
                updateUI();
            } catch(e) {}
        }

        // --- 5. USB LOGIC ---
        document.getElementById('connToggle').addEventListener('click', async () => {
            if (!isConnected) {
                if (!navigator.serial) return alert("Use Chrome");
                try {
                    port = await navigator.serial.requestPort();
                    await port.open({ baudRate: 115200 });
                    const enc = new TextEncoderStream(); enc.readable.pipeTo(port.writable); writer = enc.writable.getWriter();
                    const dec = new TextDecoderStream(); port.readable.pipeTo(dec.writable); reader = dec.readable.getReader();
                    isConnected = true; keepReading = true;
                    enableControls('usb'); readLoop();
                    setTimeout(() => { if(writer) writer.write(JSON.stringify({get_state:true})+"\n"); }, 400);
                } catch(e) { console.log(e); }
            } else {
                // Disconnect
                keepReading = false;
                if(reader) reader.cancel();
                if(port) { await new Promise(r => setTimeout(r, 100)); await port.close(); } // Hacky wait
                isConnected = false; enableControls('off');
            }
        });

        async function readLoop() {
            while(keepReading) {
                try {
                    const { value, done } = await reader.read();
                    if(done) break;
                    if(value) {
                        serialBuffer += value;
                        if(serialBuffer.includes("\n")) {
                            let lines = serialBuffer.split("\n");
                            serialBuffer = lines.pop();
                            lines.forEach(l => { if(l.trim()) parseJSON(l); });
                        }
                    }
                } catch(e) { break; }
            }
        }

        function parseJSON(str) {
            try {
                if(str.indexOf('{') > -1) {
                    let d = JSON.parse(str.substring(str.indexOf('{'), str.lastIndexOf('}')+1));
                    Object.assign(appState, d);
                    updateUI();
                }
            } catch(e) {}
        }

        // --- 6. WIFI SETUP (USB MODE ONLY) ---
        document.getElementById('wifiSetupBtn').addEventListener('click', () => {
            document.getElementById('wifiModal').style.display = 'flex';
        });

        async function saveWiFi() {
            const s = document.getElementById('wifiSSID').value;
            const p = document.getElementById('wifiPass').value;
            if(writer) {
                await writer.write(JSON.stringify({wifi_config: true, ssid: s, password: p}) + "\n");
                alert("Credentials sent! Lantern will reboot.");
                document.getElementById('wifiModal').style.display = 'none';
            }
        }

        // --- 7. UI & VISUALIZER ---
        // (Use the exact same UI/Visualizer logic from v2.11 here, simplified for brevity in this snippet)
        // Ensure you copy the createSlider, createColorInput, animate(), etc functions from v2.11
        // The key difference is `updateUI()` calls `drawControls()` and syncs inputs.
        
        function enableControls(type) {
            const on = (type !== 'off');
            document.getElementById('modeSelect').disabled = !on;
            document.getElementById('defaultBtn').disabled = !on;
            document.getElementById('wifiSetupBtn').style.display = (type === 'usb') ? 'inline-block' : 'none';
            
            if(type === 'usb') document.getElementById('connToggle').innerText = "Disconnect";
            else document.getElementById('connToggle').innerText = "Connect";
            
            document.getElementById('statusText').innerText = type.toUpperCase();
            if(on) drawControls(); else document.getElementById('controlsArea').innerHTML = "";
        }

        function updateUI() {
            document.getElementById('modeSelect').value = appState.mode;
            drawControls();
        }

        // [INSERT REST OF V2.11 JS HERE: animate(), drawControls(), widget creators, intro logic]
        // ... (See previous response for these standard functions) ...
        
        // --- 8. INTRO LOGIC (Standard) ---
        function runIntro() {
            const name = localStorage.getItem('zonai_user');
            if(name) {
                document.getElementById('nameInput').style.display = 'none';
                document.getElementById('introText').innerHTML = `Welcome back, ${name}.<br>The Shrine awaits.`;
                setTimeout(() => document.getElementById('continueBtn').style.opacity = 1, 1000);
            } else {
                document.getElementById('introText').innerText = "Greetings. Enter Name.";
            }
            // Listeners for intro...
            document.getElementById('nameInput').addEventListener('keydown', (e) => {
               if(e.key==="Enter") {
                   localStorage.setItem('zonai_user', e.target.value);
                   runIntro();
               }
            });
            document.getElementById('continueBtn').addEventListener('click', () => {
                document.getElementById('introScreen').style.display = 'none';
                document.getElementById('resetUserBtn').style.display = 'none';
                document.getElementById('offlineBtn').style.display = 'block';
                document.getElementById('mainApp').style.opacity = 1;
            });
        }
        
        // Offline/Demo Button
        document.getElementById('offlineBtn').addEventListener('click', () => {
            isOffline = !isOffline;
            if(isOffline) { 
                document.getElementById('offlineBtn').style.backgroundColor = "var(--accent)";
                enableControls('demo'); 
                isConnected = true; // Fake it for visualizer
            } else {
                document.getElementById('offlineBtn').style.backgroundColor = "";
                isConnected = false;
                enableControls('off');
            }
        });
        
        // Visualizer Loop
        function animate() {
            // ... (Copy exact animate function from v2.11) ...
            // Ensure you use isConnected || isOffline || isWiFiMode
            requestAnimationFrame(animate);
        }
        requestAnimationFrame(animate);

    </script>
</body>
</html>