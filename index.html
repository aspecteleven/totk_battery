<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lantern Control</title>
    <style>
        :root { --accent: #ffb700; --bg: #1a1a1a; --panel: #2d2d2d; --text: #eee; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; user-select: none; }
        
        h1 { font-weight: 300; letter-spacing: 4px; color: var(--accent); margin-bottom: 20px; }

        .container { background: var(--panel); padding: 30px; border-radius: 20px; width: 340px; box-shadow: 0 15px 50px rgba(0,0,0,0.5); }
        
        /* Buttons */
        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-main { background: var(--accent); color: #000; }
        .btn-main:hover { background: #ffcc40; }
        .btn-sec { background: #444; color: #aaa; }
        .btn-sec:hover { background: #555; color: #fff; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Controls */
        .control-group { margin-bottom: 25px; }
        label { display: flex; justify-content: space-between; font-size: 13px; color: #aaa; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; align-items: center;}
        
        input[type="color"] { width: 100%; height: 50px; border: none; border-radius: 8px; cursor: pointer; background: none; }
        input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; accent-color: var(--accent); }
        
        /* Standard Slider */
        input[type="range"] { width: 100%; cursor: pointer; accent-color: var(--accent); }

        /* DUAL SLIDER STYLES */
        .dual-slider-container { 
            position: relative; height: 30px; margin-top: 10px; cursor: pointer; 
        }
        .dual-slider-track { 
            position: absolute; top: 12px; left: 0; right: 0; height: 4px; 
            background: #555; border-radius: 2px; 
        }
        .dual-slider-highlight { 
            position: absolute; top: 12px; height: 4px; 
            background: var(--accent); z-index: 1; 
        }
        .thumb { 
            position: absolute; top: 3px; width: 22px; height: 22px; 
            background: #fff; border-radius: 50%; z-index: 3; 
            cursor: grab; box-shadow: 0 2px 5px rgba(0,0,0,0.5); 
            touch-action: none; 
        }
        .thumb:active { cursor: grabbing; transform: scale(1.1); background: var(--accent); }
        .thumb.disabled { background: #555; cursor: not-allowed; box-shadow: none; }

        /* Mode Switcher */
        .mode-switch { display: flex; background: #222; border-radius: 10px; padding: 5px; margin-bottom: 20px; }
        .mode-opt { flex: 1; text-align: center; padding: 10px; cursor: pointer; border-radius: 8px; font-size: 14px; color: #777; transition: 0.3s; }
        .mode-opt.active { background: #444; color: var(--accent); font-weight: bold; }

        .hidden { display: none; }
        .status { text-align: center; font-size: 12px; color: #555; margin-top: 10px; }

        /* VERSION FOOTER */
        .version { position: fixed; bottom: 10px; right: 10px; color: #444; font-size: 12px; font-weight: bold; pointer-events: none; }
    </style>
</head>
<body>

    <h1>LANTERN</h1>

    <div class="container">
        <div class="btn-group">
            <button id="connectBtn" class="btn-main">üîå CONNECT</button>
            <button id="disconnectBtn" class="btn-sec" disabled>‚ùå</button>
        </div>

        <div class="mode-switch">
            <div class="mode-opt active" id="modeSolid" onclick="setMode('solid')">SOLID</div>
            <div class="mode-opt" id="modeFade" onclick="setMode('fade')">FADE</div>
        </div>

        <div class="control-group">
            <label>Color 1</label>
            <input type="color" id="colorPicker" value="#ffe600" disabled>
        </div>

        <!-- SOLID Controls -->
        <div id="solidControls">
            <div class="control-group">
                <label>Brightness <span id="valSolidBright">80%</span></label>
                <input type="range" id="solidBright" min="0" max="1" step="0.05" value="0.8" disabled>
            </div>
        </div>

        <!-- FADE Controls -->
        <div id="fadeControls" class="hidden">
            
            <div class="control-group">
                <label>Enable 2nd Color? <input type="checkbox" id="checkFade2" disabled></label>
                <div id="color2Container" class="hidden" style="margin-top:10px">
                    <input type="color" id="colorPicker2" value="#0000ff" disabled>
                </div>
            </div>

            <div class="control-group">
                <label>Fade Range (Mix / Brightness)</label>
                <div class="dual-slider-container" id="dualContainer">
                    <div class="dual-slider-track"></div>
                    <div class="dual-slider-highlight" id="rangeHighlight"></div>
                    <div class="thumb" id="thumbMin"></div>
                    <div class="thumb" id="thumbMax"></div>
                </div>
            </div>

            <div class="control-group" style="margin-top:40px">
                <label>Fade Speed <span id="valSpeed">1.0</span></label>
                <input type="range" id="fadeSpeed" min="0.1" max="3.0" step="0.1" value="0.5" disabled>
            </div>
        </div>

        <button id="defaultBtn" class="btn-sec" style="width:100%" disabled>RESET TO DEFAULTS</button>
        <div class="status" id="statusText">Ready to connect</div>
    </div>

    <div class="version">v1.2</div>

    <script>
        let port, writer;
        let currentMode = "solid";
        let controlsEnabled = false;

        let appState = {
            solid_color: [255, 230, 0], 
            solid_bright: 0.8,
            fade_color: [255, 140, 0], 
            fade_color_2: [0, 0, 255],
            fade_use_2: false,
            fade_min: 0.1, 
            fade_max: 0.9, 
            fade_speed: 0.5
        };
        
        const ui = {
            connect: document.getElementById('connectBtn'),
            disconnect: document.getElementById('disconnectBtn'),
            solidDiv: document.getElementById('solidControls'),
            fadeDiv: document.getElementById('fadeControls'),
            color: document.getElementById('colorPicker'),
            solidBright: document.getElementById('solidBright'),
            // Fade specific
            checkFade2: document.getElementById('checkFade2'),
            color2: document.getElementById('colorPicker2'),
            color2Box: document.getElementById('color2Container'),
            fadeSpeed: document.getElementById('fadeSpeed'),
            status: document.getElementById('statusText'),
            valSolid: document.getElementById('valSolidBright'),
            valSpeed: document.getElementById('valSpeed'),
            dualContainer: document.getElementById('dualContainer'),
            thumbMin: document.getElementById('thumbMin'),
            thumbMax: document.getElementById('thumbMax'),
            rangeHighlight: document.getElementById('rangeHighlight')
        };

        // --- USB ---
        ui.connect.addEventListener('click', async () => {
            if (!navigator.serial) return alert("Browser not supported.");
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                const encoder = new TextEncoderStream();
                encoder.readable.pipeTo(port.writable);
                writer = encoder.writable.getWriter();
                
                sendRaw({get_state: true}); 
                enableControls(true);
                readLoop(); 
            } catch (e) { console.log(e); ui.status.innerText = "Connection Failed"; }
        });

        ui.disconnect.addEventListener('click', async () => {
            if (writer) {
                try {
                    await writer.close();
                    await port.close();
                } catch(e){}
                writer = null; port = null;
                enableControls(false);
            }
        });

        function enableControls(enabled) {
            controlsEnabled = enabled;
            ui.connect.disabled = enabled;
            ui.disconnect.disabled = !enabled;
            ui.color.disabled = !enabled;
            ui.solidBright.disabled = !enabled;
            ui.fadeSpeed.disabled = !enabled;
            ui.checkFade2.disabled = !enabled;
            ui.color2.disabled = !enabled;
            document.getElementById('defaultBtn').disabled = !enabled;
            
            if(enabled) {
                ui.thumbMin.classList.remove('disabled');
                ui.thumbMax.classList.remove('disabled');
            } else {
                ui.thumbMin.classList.add('disabled');
                ui.thumbMax.classList.add('disabled');
            }
            ui.status.innerText = enabled ? "Connected" : "Disconnected";
        }

        async function readLoop() {
            const decoder = new TextDecoderStream();
            port.readable.pipeTo(decoder.writable);
            const reader = decoder.readable.getReader();
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    if (value) parseIncoming(value);
                }
            } catch (e) { console.log(e); }
        }

        function parseIncoming(text) {
            if(text.indexOf('{') > -1) {
                try {
                    let jsonStr = text.substring(text.indexOf('{'), text.lastIndexOf('}')+1);
                    let data = JSON.parse(jsonStr);
                    Object.assign(appState, data);
                    updateUI();
                } catch(e) {}
            }
        }

        // --- UI LOGIC ---
        window.setMode = (mode) => {
            currentMode = mode;
            document.getElementById('modeSolid').classList.toggle('active', mode === 'solid');
            document.getElementById('modeFade').classList.toggle('active', mode === 'fade');
            ui.solidDiv.classList.toggle('hidden', mode !== 'solid');
            ui.fadeDiv.classList.toggle('hidden', mode !== 'fade');
            updateUI();
            sendData(true);
        };

        function updateUI() {
            if(currentMode === 'solid') {
                ui.color.value = rgbToHex(appState.solid_color);
                ui.solidBright.value = appState.solid_bright;
                ui.valSolid.innerText = Math.round(appState.solid_bright*100) + "%";
            } else {
                ui.color.value = rgbToHex(appState.fade_color);
                
                // Color 2 logic
                ui.checkFade2.checked = appState.fade_use_2;
                if(appState.fade_use_2) {
                    ui.color2Box.classList.remove('hidden');
                    ui.color2.value = rgbToHex(appState.fade_color_2);
                } else {
                    ui.color2Box.classList.add('hidden');
                }

                ui.fadeSpeed.value = appState.fade_speed;
                ui.valSpeed.innerText = appState.fade_speed + "x";
                drawDualSlider();
            }
        }

        // --- CUSTOM DUAL SLIDER ---
        function drawDualSlider() {
            const min = appState.fade_min;
            const max = appState.fade_max;
            const left = min * 100;
            const width = (max - min) * 100;
            
            ui.thumbMin.style.left = `calc(${left}% - 11px)`;
            ui.thumbMax.style.left = `calc(${left + width}% - 11px)`;
            ui.rangeHighlight.style.left = left + "%";
            ui.rangeHighlight.style.width = width + "%";
        }

        function initDualSlider() {
            const track = ui.dualContainer;
            
            function handleDrag(e, isMin) {
                if(!controlsEnabled) return;
                e.preventDefault();
                const rect = track.getBoundingClientRect();
                let clientX = e.clientX;
                if(e.touches && e.touches.length > 0) clientX = e.touches[0].clientX;

                let val = (clientX - rect.left) / rect.width;
                if(val < 0) val = 0; if(val > 1) val = 1;
                val = Math.round(val * 20) / 20;

                if(isMin) {
                    if(val >= appState.fade_max) val = appState.fade_max - 0.05;
                    appState.fade_min = val;
                } else {
                    if(val <= appState.fade_min) val = appState.fade_min + 0.05;
                    appState.fade_max = val;
                }
                drawDualSlider();
                sendData(false);
            }

            ui.thumbMin.onmousedown = (e) => {
                document.onmousemove = (ev) => handleDrag(ev, true);
                document.onmouseup = () => { document.onmousemove = null; sendData(true); };
            };
            ui.thumbMax.onmousedown = (e) => {
                document.onmousemove = (ev) => handleDrag(ev, false);
                document.onmouseup = () => { document.onmousemove = null; sendData(true); };
            };
            ui.thumbMin.ontouchstart = (e) => {
                document.ontouchmove = (ev) => handleDrag(ev, true);
                document.ontouchend = () => { document.ontouchmove = null; sendData(true); };
            };
            ui.thumbMax.ontouchstart = (e) => {
                document.ontouchmove = (ev) => handleDrag(ev, false);
                document.ontouchend = () => { document.ontouchmove = null; sendData(true); };
            };
        }

        initDualSlider();

        // --- DATA IO ---
        function rgbToHex(rgb) {
            if(!Array.isArray(rgb)) return "#ffffff"; 
            return "#" + ((1 << 24) + (rgb[0] << 16) + (rgb[1] << 8) + rgb[2]).toString(16).slice(1);
        }

        function hexToRgb(hex) {
            const res = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return res ? [parseInt(res[1], 16), parseInt(res[2], 16), parseInt(res[3], 16)] : [0,0,0];
        }

        function saveToState(sendSaveCmd) {
            const color = hexToRgb(ui.color.value);
            if(currentMode === 'solid') {
                appState.solid_color = color;
                appState.solid_bright = parseFloat(ui.solidBright.value);
                ui.valSolid.innerText = Math.round(appState.solid_bright*100) + "%";
            } else {
                appState.fade_color = color;
                // Capture the Checkbox state HERE
                appState.fade_use_2 = ui.checkFade2.checked;
                appState.fade_color_2 = hexToRgb(ui.color2.value);
                
                appState.fade_speed = parseFloat(ui.fadeSpeed.value);
                ui.valSpeed.innerText = appState.fade_speed + "x";
            }
            sendData(sendSaveCmd);
        }

        async function sendData(save) {
            if (!writer) return;
            const payload = {
                mode: currentMode,
                solid_color: appState.solid_color,
                solid_bright: appState.solid_bright,
                fade_color: appState.fade_color,
                fade_color_2: appState.fade_color_2,
                fade_use_2: appState.fade_use_2,
                fade_min: appState.fade_min,
                fade_max: appState.fade_max,
                fade_speed: appState.fade_speed,
                save: save
            };
            sendRaw(payload);
        }

        async function sendRaw(payload) {
            if (!writer) return;
            try {
                await writer.write(JSON.stringify(payload));
            } catch(e) {
                 ui.status.innerText = "Error Sending - Check Connection";
            }
        }

        ['input'].forEach(evt => {
            ui.color.addEventListener(evt, () => saveToState(false));
            ui.solidBright.addEventListener(evt, () => saveToState(false));
            ui.fadeSpeed.addEventListener(evt, () => saveToState(false));
            ui.color2.addEventListener(evt, () => saveToState(false));
        });
        
        ['change'].forEach(evt => {
            ui.color.addEventListener(evt, () => saveToState(true));
            ui.solidBright.addEventListener(evt, () => saveToState(true));
            ui.fadeSpeed.addEventListener(evt, () => saveToState(true));
            ui.color2.addEventListener(evt, () => saveToState(true));
            // FIXED EVENT LISTENER ORDER
            ui.checkFade2.addEventListener(evt, () => {
                saveToState(true); // 1. Save checkbox state to Memory
                updateUI();        // 2. Update screen (show color 2 box)
            });
        });

        document.getElementById('defaultBtn').addEventListener('click', () => {
           appState = {
                solid_color: [255, 230, 0], solid_bright: 0.8,
                fade_color: [255, 140, 0], fade_color_2: [0,0,255], fade_use_2: false,
                fade_min: 0.1, fade_max: 0.9, fade_speed: 0.5
           };
           setMode('solid'); 
        });
        
    </script>
</body>
</html>