<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shrine Lantern Controller</title>
    <style>
        /* --- CORE VARIABLES --- */
        :root { 
            --accent: #ffb700; 
            --accent-dim: #997a23;
            --panel-bg: rgba(16, 34, 46, 0.95); 
            --text: #a8d8e6; 
            
            /* Dynamic Glow Variables updated by JS */
            --glow-color: 255, 255, 0; 
            --glow-color-light: 255, 255, 200;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #10222e;
            box-shadow: inset 0 0 20vh #091320;
            color: var(--text);
            height: 100vh;
            width: 100vw;
            overflow: hidden; 
            user-select: none;
        }

        /* --- BACKGROUND ART --- */
        .container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .stones { position: absolute; width: 261px; height: 100%; top: 0; z-index: 10; mix-blend-mode: lighten; pointer-events: none;}
        .stone_overlay { position: absolute; width: 500px; height: 100%; z-index: 9; pointer-events: none;}
        
        .stone_overlay_left { left: 0; background: url("images/stone_overlay_left.webp") no-repeat left; background-size: auto 100%; }
        .stone_overlay_right { right: 0; background: url("images/stone_overlay_right.webp") no-repeat right; background-size: auto 100%; }
        .stone_left { left: 0; background: url("images/stone_left.webp") no-repeat left; background-size: auto 100%; }
        .stone_right { right: 0; background: url("images/stone_right.webp") no-repeat right; background-size: auto 100%; }

        .elements { position: absolute; width: 100%; height: 80px; left: 0; z-index: 5; pointer-events: none;}
        .elements_top { top: 0; background: url("images/elements_top.png"); }
        .elements_bottom { bottom: 0; background: url("images/elements_bottom.png"); opacity: .6; }

        /* --- BATTERY DISPLAY --- */
        .battery_container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center; z-index: 20;
            pointer-events: none; 
        }

        /* NO SCALING - Native Size */
        .battery_display { 
            position: relative; 
            width: 474px; 
            height: 779px; 
        }   

        .battery_body {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: url("images/battery_body_dark.png") no-repeat; z-index: 21;
        }
        .battery_body:before {
            content: " "; position: absolute; top: 0; left: 0; width: 100%; height: 110%;
            filter: drop-shadow(0 5px 5px rgba(0, 0, 0, 0.5));
            background: url("images/battery_body_dark.png") no-repeat;
            mask-image: linear-gradient(to bottom, transparent 9%, black 100%);
        }

        .battery_glass {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: url("images/battery_glass.png") no-repeat; z-index: 22;
        }

        .battery_glass_glow {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 23;
            background: radial-gradient(circle, rgba(var(--glow-color-light), 1) 0%, rgba(var(--glow-color), 1) 100%);
            -webkit-mask-image: url("images/battery_glass_mask_glow.png");
            mask-image: url("images/battery_glass_mask_glow.png");
            -webkit-mask-repeat: no-repeat; mask-repeat: no-repeat;
            -webkit-mask-size: 100% auto; mask-size: 100% auto;
            -webkit-mask-position: center; mask-position: center;
            mix-blend-mode: overlay;
            transition: background 0.1s; 
        }

        .battery_glass_glow_overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: url("images/battery_glass.png") no-repeat; z-index: 24;
            opacity: .5; mix-blend-mode: multiply;
        }
        .battery_glass_glow_overlay:before {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: url("images/battery_glass_mask_glow.png") no-repeat;
            filter: drop-shadow(0 0 10px rgba(var(--glow-color), 1))
                    drop-shadow(0 0 150px rgba(var(--glow-color), 1))
                    drop-shadow(0 0 50px rgba(var(--glow-color-light), 1));
            transition: filter 0.1s;
        }

        /* --- DASHBOARD CONTROL PANEL (Wide & Short) --- */
        .control-panel {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 900px;
            max-width: 95vw;
            height: 140px;
            background: var(--panel-bg);
            border: 2px solid var(--accent-dim);
            border-radius: 16px;
            padding: 15px 25px;
            z-index: 100;
            backdrop-filter: blur(8px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }

        h1 {
            position: absolute; top: -30px; left: 20px;
            font-weight: 300; letter-spacing: 4px; color: var(--accent);
            font-size: 14px; text-shadow: 0 0 5px black;
        }

        /* SECTIONS within the dashboard */
        .dashboard-section {
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
        }

        /* SECTION 1: SYSTEM (Connect & Mode) */
        .sec-system { width: 140px; border-right: 1px solid rgba(255,255,255,0.1); padding-right: 20px; }
        
        #connToggle {
            width: 100%; padding: 10px; margin-bottom: 10px;
            border: 1px solid var(--accent); border-radius: 6px;
            font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 12px;
            transition: 0.3s;
        }
        .btn-connect { background: rgba(0,255,0,0.1); color: var(--text); border-color: #4CAF50; }
        .btn-connect:hover { background: #4CAF50; color: #000; }
        .btn-disconnect { background: rgba(255, 0, 0, 0.1); color: #ff6b6b; border-color: #ff6b6b; }
        .btn-disconnect:hover { background: #ff6b6b; color: #000; }

        .mode-switch { display: flex; background: rgba(0,0,0,0.3); border-radius: 6px; padding: 2px; border: 1px solid #444; }
        .mode-opt {
            flex: 1; text-align: center; padding: 6px; cursor: pointer;
            border-radius: 4px; font-size: 11px; color: #777; transition: 0.3s;
        }
        .mode-opt.active { background: var(--accent-dim); color: #fff; }


        /* SECTION 2: CONTROLS (Dynamic) */
        .sec-controls { flex: 1; display: flex; align-items: center; gap: 30px; padding: 0 10px; }
        
        /* Inner containers for Solid/Fade to layout their items horizontally */
        #solidControls, #fadeControls {
            display: flex; width: 100%; align-items: center; justify-content: space-around; gap: 20px;
        }
        
        .control-group { display: flex; flex-direction: column; min-width: 100px; }
        label { font-size: 10px; color: #888; text-transform: uppercase; margin-bottom: 5px; display: flex; justify-content: space-between; }
        
        input[type="color"] {
            width: 80px; height: 35px; border: 1px solid var(--accent-dim);
            background: none; cursor: pointer; border-radius: 4px;
        }
        input[type="checkbox"] { width: 14px; height: 14px; accent-color: var(--accent); cursor: pointer; margin-left: 5px; }

        /* SECTION 3: ACTIONS (Reset) */
        .sec-actions { border-left: 1px solid rgba(255,255,255,0.1); padding-left: 20px; display: flex; flex-direction: column; justify-content: space-between; height: 60%; }
        
        #defaultBtn {
            background: transparent; border: 1px solid #555; color: #777;
            padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 10px; text-transform: uppercase;
        }
        #defaultBtn:hover { background: #333; color: #fff; }
        #defaultBtn:disabled { opacity: 0.2; cursor: not-allowed; }

        .status { font-size: 10px; color: #555; text-align: right; margin-top: auto; }

        /* SLIDERS */
        .custom-slider-container { position: relative; height: 20px; width: 100%; min-width: 160px; margin-top: 5px; cursor: pointer; }
        .custom-slider-track { position: absolute; top: 8px; left: 0; right: 0; height: 4px; background: #333; border-radius: 2px; }
        .custom-slider-highlight { position: absolute; top: 8px; height: 4px; background: var(--accent); z-index: 1; box-shadow: 0 0 5px var(--accent); }
        .thumb {
            position: absolute; top: 0px; width: 20px; height: 20px;
            background: #10222e; border: 2px solid var(--accent);
            border-radius: 50%; z-index: 3; cursor: grab;
            box-shadow: 0 0 5px #000;
        }
        .thumb:active { background: var(--accent); }
        
        .custom-slider-container.disabled .custom-slider-highlight { background: #555; box-shadow: none; }
        .custom-slider-container.disabled .thumb { border-color: #555; cursor: not-allowed; }

        .hidden { display: none !important; }
        .version { position: fixed; bottom: 5px; right: 10px; color: rgba(255,255,255,0.1); font-size: 10px; pointer-events: none; }

    </style>
</head>
<body>

    <!-- ARTWORK -->
    <div class="container">
        <div class="stone_overlay stone_overlay_left"></div>
        <div class="stone_overlay stone_overlay_right"></div>
        <div class="stones stone_left"></div>
        <div class="stones stone_right"></div>
        <div class="elements elements_top"></div>
        <div class="elements elements_bottom"></div>
    </div>
    <div class="battery_container">
        <div class="battery_display">
            <div class="battery_body"></div>
            <div class="battery_glass"></div>
            <div class="battery_glass_glow"></div>
            <div class="battery_glass_glow_overlay"></div>
        </div>
    </div>

    <!-- DASHBOARD PANEL -->
    <div class="control-panel">
        <h1>LANTERN CONTROL</h1>

        <!-- SECTION 1: SYSTEM -->
        <div class="dashboard-section sec-system">
            <button id="connToggle" class="btn-connect">Connect</button>
            <div class="mode-switch">
                <div class="mode-opt active" id="modeSolid" onclick="setMode('solid')">SOLID</div>
                <div class="mode-opt" id="modeFade" onclick="setMode('fade')">FADE</div>
            </div>
        </div>

        <!-- SECTION 2: CONTROLS -->
        <div class="dashboard-section sec-controls">
            
            <!-- SOLID MODE UI -->
            <div id="solidControls">
                <div class="control-group">
                    <label>Color</label>
                    <input type="color" id="colorPicker" value="#ffe600" disabled>
                </div>
                <div class="control-group" style="flex:1; max-width: 300px;">
                    <label>Brightness <span id="valSolidBright">80%</span></label>
                    <div class="custom-slider-container disabled" id="solidBrightContainer">
                        <div class="custom-slider-track"></div>
                        <div class="custom-slider-highlight" id="solidBrightHighlight"></div>
                        <div class="thumb" id="solidBrightThumb"></div>
                    </div>
                </div>
            </div>

            <!-- FADE MODE UI -->
            <div id="fadeControls" class="hidden">
                <div class="control-group">
                    <label>Color 1</label>
                    <input type="color" id="fadeColorPicker1" value="#ffc800" disabled>
                </div>
                
                <div class="control-group">
                    <label>Color 2 <input type="checkbox" id="checkFade2" disabled></label>
                    <div id="color2Container" class="hidden">
                        <input type="color" id="fadeColorPicker2" value="#ffdc00" disabled>
                    </div>
                </div>

                <div class="control-group" style="flex:1;">
                    <label>Range <span style="font-size:9px">(Min/Max)</span></label>
                    <div class="custom-slider-container disabled" id="dualContainer">
                        <div class="custom-slider-track"></div>
                        <div class="custom-slider-highlight" id="rangeHighlight"></div>
                        <div class="thumb" id="thumbMin"></div>
                        <div class="thumb" id="thumbMax"></div>
                    </div>
                </div>

                <div class="control-group" style="flex:1;">
                    <label>Speed <span id="valSpeed">0.9x</span></label>
                    <div class="custom-slider-container disabled" id="speedContainer">
                        <div class="custom-slider-track"></div>
                        <div class="custom-slider-highlight" id="speedHighlight"></div>
                        <div class="thumb" id="speedThumb"></div>
                    </div>
                </div>
            </div>

        </div>

        <!-- SECTION 3: ACTIONS -->
        <div class="dashboard-section sec-actions">
            <button id="defaultBtn" disabled>Defaults</button>
            <div class="status" id="statusText">Ready</div>
        </div>

    </div>

    <div class="version">v1.8</div>

    <!-- LOGIC -->
    <script>
        let port, writer;
        let currentMode = "solid";
        let controlsEnabled = false;
        let isConnected = false;

        let appState = {
            solid_color: [255, 230, 0], solid_bright: 0.8,
            fade_color: [255, 200, 0], fade_color_2: [255, 220, 0],
            fade_use_2: true, fade_min: 0.1, fade_max: 0.9, fade_speed: 0.9
        };
        
        const ui = {
            connToggle: document.getElementById('connToggle'),
            solidDiv: document.getElementById('solidControls'),
            fadeDiv: document.getElementById('fadeControls'),
            
            colorSolid: document.getElementById('colorPicker'),
            colorFade1: document.getElementById('fadeColorPicker1'),
            colorFade2: document.getElementById('fadeColorPicker2'),
            checkFade2: document.getElementById('checkFade2'),
            color2Box: document.getElementById('color2Container'),
            
            status: document.getElementById('statusText'),
            valSolid: document.getElementById('valSolidBright'),
            valSpeed: document.getElementById('valSpeed'),

            sliders: {
                solidBright: { container: document.getElementById('solidBrightContainer'), thumb: document.getElementById('solidBrightThumb'), highlight: document.getElementById('solidBrightHighlight') },
                speed: { container: document.getElementById('speedContainer'), thumb: document.getElementById('speedThumb'), highlight: document.getElementById('speedHighlight') },
                dual: { container: document.getElementById('dualContainer'), thumbMin: document.getElementById('thumbMin'), thumbMax: document.getElementById('thumbMax'), highlight: document.getElementById('rangeHighlight') }
            }
        };

        // --- VISUALIZER LOOP ---
        function animateLantern() {
            const now = Date.now() / 1000; 
            let r, g, b;

            if (currentMode === 'solid') {
                [r, g, b] = appState.solid_color;
                const br = appState.solid_bright;
                r *= br; g *= br; b *= br;
            } else {
                const speed = appState.fade_speed;
                const sineVal = (Math.sin(now * speed * 3) + 1) / 2;
                const range = appState.fade_max - appState.fade_min;
                const mixFactor = appState.fade_min + (sineVal * range);

                if (appState.fade_use_2) {
                    const c1 = appState.fade_color;
                    const c2 = appState.fade_color_2;
                    r = c1[0] + (c2[0] - c1[0]) * mixFactor;
                    g = c1[1] + (c2[1] - c1[1]) * mixFactor;
                    b = c1[2] + (c2[2] - c1[2]) * mixFactor;
                } else {
                    [r, g, b] = appState.fade_color;
                    r *= mixFactor; g *= mixFactor; b *= mixFactor;
                }
            }
            updateGlowVariables(r, g, b);
            requestAnimationFrame(animateLantern);
        }

        function updateGlowVariables(r, g, b) {
            r = Math.round(r); g = Math.round(g); b = Math.round(b);
            document.documentElement.style.setProperty('--glow-color', `${r}, ${g}, ${b}`);
            const factor = 0.7; 
            const lr = Math.round(r + (255 - r) * factor);
            const lg = Math.round(g + (255 - g) * factor);
            const lb = Math.round(b + (255 - b) * factor);
            document.documentElement.style.setProperty('--glow-color-light', `${lr}, ${lg}, ${lb}`);
        }
        requestAnimationFrame(animateLantern);

        // --- USB CONNECTION HANDLER ---
        ui.connToggle.addEventListener('click', async () => {
            if (!isConnected) {
                // Try to Connect
                if (!navigator.serial) return alert("Browser not supported (Use Chrome/Edge).");
                try {
                    port = await navigator.serial.requestPort();
                    await port.open({ baudRate: 115200 });
                    const encoder = new TextEncoderStream();
                    encoder.readable.pipeTo(port.writable);
                    writer = encoder.writable.getWriter();
                    
                    sendRaw({get_state: true}); 
                    enableControls(true);
                    readLoop(); 
                } catch (e) { console.log(e); ui.status.innerText = "Failed"; }
            } else {
                // Disconnect
                if (writer) {
                    try { await writer.close(); await port.close(); } catch(e){}
                    writer = null; port = null;
                    enableControls(false);
                }
            }
        });

        function enableControls(enabled) {
            isConnected = enabled;
            controlsEnabled = enabled;
            
            // Toggle Button Visuals
            if(enabled) {
                ui.connToggle.innerText = "Disconnect";
                ui.connToggle.classList.remove('btn-connect');
                ui.connToggle.classList.add('btn-disconnect');
                ui.status.innerText = "Connected";
            } else {
                ui.connToggle.innerText = "Connect";
                ui.connToggle.classList.add('btn-connect');
                ui.connToggle.classList.remove('btn-disconnect');
                ui.status.innerText = "Disconnected";
            }
            
            // Enable/Disable Inputs
            ui.colorSolid.disabled = !enabled;
            ui.colorFade1.disabled = !enabled;
            ui.colorFade2.disabled = !enabled;
            ui.checkFade2.disabled = !enabled;
            document.getElementById('defaultBtn').disabled = !enabled;
            
            // Enable/Disable Sliders
            Object.values(ui.sliders).forEach(s => {
                if(enabled) s.container.classList.remove('disabled');
                else s.container.classList.add('disabled');
            });
        }

        async function readLoop() {
            const decoder = new TextDecoderStream();
            port.readable.pipeTo(decoder.writable);
            const reader = decoder.readable.getReader();
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    if (value) parseIncoming(value);
                }
            } catch (e) { console.log(e); }
        }

        function parseIncoming(text) {
            if(text.indexOf('{') > -1) {
                try {
                    let jsonStr = text.substring(text.indexOf('{'), text.lastIndexOf('}')+1);
                    let data = JSON.parse(jsonStr);
                    Object.assign(appState, data);
                    updateUI();
                } catch(e) {}
            }
        }

        // --- DATA IO ---
        async function sendRaw(payload) {
            if (!writer) return;
            try { await writer.write(JSON.stringify(payload)); } 
            catch(e) { ui.status.innerText = "Error Sending"; }
        }

        async function sendData(save) {
            if (!writer) return;
            const payload = {
                mode: currentMode,
                solid_color: appState.solid_color,
                solid_bright: appState.solid_bright,
                fade_color: appState.fade_color,
                fade_color_2: appState.fade_color_2,
                fade_use_2: appState.fade_use_2,
                fade_min: appState.fade_min,
                fade_max: appState.fade_max,
                fade_speed: appState.fade_speed,
                save: save
            };
            sendRaw(payload);
        }

        // --- SLIDERS ---
        function initSlider(config) {
            const { container, thumb, highlight, type, min, max, step, stateKey, onUpdate } = config;

            function updateVisuals() {
                if (type === 'single') {
                    const val = appState[stateKey];
                    const percent = (val - min) / (max - min) * 100;
                    thumb.style.left = `calc(${percent}% - 10px)`; // Adjusted for 20px thumb
                    highlight.style.width = `${percent}%`;
                    highlight.style.left = '0';
                    if(onUpdate) onUpdate(val);
                } else {
                    const valMin = appState[stateKey[0]];
                    const valMax = appState[stateKey[1]];
                    const pMin = (valMin - min) / (max - min) * 100;
                    const pMax = (valMax - min) / (max - min) * 100;
                    
                    config.thumbMin.style.left = `calc(${pMin}% - 10px)`;
                    config.thumbMax.style.left = `calc(${pMax}% - 10px)`;
                    highlight.style.left = `${pMin}%`;
                    highlight.style.width = `${pMax - pMin}%`;
                }
            }

            function handleDrag(e, isThumbMax) {
                if(!controlsEnabled) return;
                e.preventDefault();
                const rect = container.getBoundingClientRect();
                let clientX = e.clientX;
                if(e.touches && e.touches.length > 0) clientX = e.touches[0].clientX;

                let percent = (clientX - rect.left) / rect.width;
                if(percent < 0) percent = 0; if(percent > 1) percent = 1;

                let val = min + (percent * (max - min));
                val = Math.round(val / step) * step; 
                val = parseFloat(val.toFixed(2));

                if (type === 'single') {
                    appState[stateKey] = val;
                } else {
                    if (!isThumbMax) { 
                        if(val >= appState[stateKey[1]]) val = appState[stateKey[1]] - step;
                        appState[stateKey[0]] = val;
                    } else { 
                        if(val <= appState[stateKey[0]]) val = appState[stateKey[0]] + step;
                        appState[stateKey[1]] = val;
                    }
                    val = parseFloat(val.toFixed(2));
                }
                updateVisuals();
                sendData(false);
            }

            function addListeners(elem, isThumbMax = false) {
                const start = (e) => {
                    const move = (ev) => handleDrag(ev, isThumbMax);
                    const end = () => { 
                        document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', end);
                        document.removeEventListener('touchmove', move); document.removeEventListener('touchend', end);
                        sendData(true); 
                    };
                    document.addEventListener('mousemove', move); document.addEventListener('mouseup', end);
                    document.addEventListener('touchmove', move); document.addEventListener('touchend', end);
                };
                elem.addEventListener('mousedown', start); elem.addEventListener('touchstart', start);
            }

            if(type === 'single') {
                addListeners(thumb);
                container.addEventListener('mousedown', (e) => { if(e.target === thumb) return; handleDrag(e); sendData(true); });
            } else {
                addListeners(config.thumbMin, false);
                addListeners(config.thumbMax, true);
            }
            return updateVisuals;
        }

        const drawSolidBright = initSlider({ container: ui.sliders.solidBright.container, thumb: ui.sliders.solidBright.thumb, highlight: ui.sliders.solidBright.highlight, type: 'single', min: 0, max: 1, step: 0.05, stateKey: 'solid_bright', onUpdate: (v) => ui.valSolid.innerText = Math.round(v*100) + "%" });
        const drawSpeed = initSlider({ container: ui.sliders.speed.container, thumb: ui.sliders.speed.thumb, highlight: ui.sliders.speed.highlight, type: 'single', min: 0.1, max: 3.0, step: 0.1, stateKey: 'fade_speed', onUpdate: (v) => ui.valSpeed.innerText = v + "x" });
        const drawDual = initSlider({ container: ui.sliders.dual.container, thumbMin: ui.sliders.dual.thumbMin, thumbMax: ui.sliders.dual.thumbMax, highlight: ui.sliders.dual.highlight, type: 'dual', min: 0, max: 1, step: 0.05, stateKey: ['fade_min', 'fade_max'] });

        // --- UI UPDATES ---
        window.setMode = (mode) => {
            currentMode = mode;
            document.getElementById('modeSolid').classList.toggle('active', mode === 'solid');
            document.getElementById('modeFade').classList.toggle('active', mode === 'fade');
            ui.solidDiv.classList.toggle('hidden', mode !== 'solid');
            ui.fadeDiv.classList.toggle('hidden', mode !== 'fade');
            updateUI();
            sendData(true);
        };

        function updateUI() {
            if(currentMode === 'solid') {
                ui.colorSolid.value = rgbToHex(appState.solid_color);
                drawSolidBright();
            } else {
                ui.colorFade1.value = rgbToHex(appState.fade_color);
                ui.checkFade2.checked = appState.fade_use_2;
                if(appState.fade_use_2) {
                    ui.color2Box.classList.remove('hidden');
                    ui.colorFade2.value = rgbToHex(appState.fade_color_2);
                } else {
                    ui.color2Box.classList.add('hidden');
                }
                drawSpeed(); drawDual();
            }
        }

        function rgbToHex(rgb) {
            if(!Array.isArray(rgb)) return "#ffffff"; 
            return "#" + ((1 << 24) + (rgb[0] << 16) + (rgb[1] << 8) + rgb[2]).toString(16).slice(1);
        }

        function hexToRgb(hex) {
            const res = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return res ? [parseInt(res[1], 16), parseInt(res[2], 16), parseInt(res[3], 16)] : [0,0,0];
        }

        function saveToState(sendSaveCmd) {
            if(currentMode === 'solid') {
                appState.solid_color = hexToRgb(ui.colorSolid.value);
            } else {
                appState.fade_color = hexToRgb(ui.colorFade1.value);
                appState.fade_color_2 = hexToRgb(ui.colorFade2.value);
                appState.fade_use_2 = ui.checkFade2.checked;
            }
            sendData(sendSaveCmd);
        }

        ['input'].forEach(evt => {
            ui.colorSolid.addEventListener(evt, () => saveToState(false));
            ui.colorFade1.addEventListener(evt, () => saveToState(false));
            ui.colorFade2.addEventListener(evt, () => saveToState(false));
        });
        ['change'].forEach(evt => {
            ui.colorSolid.addEventListener(evt, () => saveToState(true));
            ui.colorFade1.addEventListener(evt, () => saveToState(true));
            ui.colorFade2.addEventListener(evt, () => saveToState(true));
            ui.checkFade2.addEventListener(evt, () => { saveToState(true); updateUI(); });
        });
        document.getElementById('defaultBtn').addEventListener('click', () => {
           appState = {
                solid_color: [255, 230, 0], solid_bright: 0.8,
                fade_color: [255, 200, 0], fade_color_2: [255, 220, 0], 
                fade_use_2: true, fade_min: 0.1, fade_max: 0.9, fade_speed: 0.9
           };
           setMode('solid'); 
        });

    </script>
</body>
</html>