<!DOCTYPE html>
<html>
<head>
    <title>Lantern Pro</title>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: #eee; text-align: center; padding: 20px; }
        .card { background: #2a2a2a; padding: 20px; border-radius: 15px; display: inline-block; width: 320px; box-shadow: 0 10px 20px rgba(0,0,0,0.4); }
        button { width: 100%; padding: 12px; margin: 5px 0; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        .btn-connect { background: #00d4ff; color: #000; }
        .btn-default { background: #444; color: #fff; }
        .btn-disconnect { background: #ff4444; color: #fff; margin-top: 20px; }
        .control { text-align: left; margin: 15px 0; }
        label { font-size: 12px; color: #888; text-transform: uppercase; }
        input { width: 100%; }
        select { width: 100%; padding: 8px; background: #333; color: white; border: 1px solid #444; }
    </style>
</head>
<body>
    <div class="card">
        <h2>LANTERN</h2>
        <button id="connectBtn" class="btn-connect">Connect Lantern</button>
        
        <div class="control">
            <label>Mode</label>
            <select id="mode">
                <option value="0">Solid Color</option>
                <option value="1">Breathing/Fade</option>
            </select>
        </div>

        <div class="control">
            <label>Color</label>
            <input type="color" id="color" value="#ffe600">
        </div>

        <div class="control">
            <label>Brightness</label>
            <input type="range" id="brightness" min="0" max="1" step="0.05" value="0.8">
        </div>

        <div id="fadeControls" style="display:none">
            <div class="control">
                <label>Fade Speed</label>
                <input type="range" id="speed" min="0" max="1" step="0.1" value="0.5">
            </div>
            <div class="control">
                <label>Variety (Randomness)</label>
                <input type="range" id="variety" min="0" max="1" step="0.1" value="0.5">
            </div>
        </div>

        <button id="defaultBtn" class="btn-default">Reset to Default</button>
        <button id="disconnectBtn" class="btn-disconnect" style="display:none">Disconnect</button>
    </div>

    <script>
        let port, writer;
        const els = {
            connect: document.getElementById('connectBtn'),
            mode: document.getElementById('mode'),
            color: document.getElementById('color'),
            bright: document.getElementById('brightness'),
            speed: document.getElementById('speed'),
            variety: document.getElementById('variety'),
            fadeGroup: document.getElementById('fadeControls'),
            default: document.getElementById('defaultBtn'),
            disconnect: document.getElementById('disconnectBtn')
        };

        async function send() {
            if (!writer) return;
            const hex = els.color.value;
            const r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16);
            const data = {
                mode: parseInt(els.mode.value),
                color: [r, g, b],
                brightness: parseFloat(els.bright.value),
                speed: parseFloat(els.speed.value),
                variety: parseFloat(els.variety.value)
            };
            els.fadeGroup.style.display = data.mode === 1 ? 'block' : 'none';
            await writer.write(JSON.stringify(data));
        }

        els.connect.onclick = async () => {
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: 115200 });
            const encoder = new TextEncoderStream();
            encoder.readable.pipeTo(port.writable);
            writer = encoder.writable.getWriter();
            els.connect.innerText = "Connected";
            els.disconnect.style.display = 'block';
        };

        els.disconnect.onclick = async () => {
            await writer.releaseLock();
            await port.close();
            location.reload();
        };

        els.default.onclick = () => {
            els.mode.value = "0";
            els.color.value = "#ffe600";
            els.bright.value = "0.8";
            els.speed.value = "0.5";
            els.variety.value = "0.5";
            send();
        };

        [els.mode, els.color, els.bright, els.speed, els.variety].forEach(el => el.oninput = send);
    </script>
</body>
</html>